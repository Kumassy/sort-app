<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">

<!-- <link rel="import" href="../../bower_components/prism-element/prism-element.html"> -->
<link rel="import" href="../../bower_components/prism-js/prism-js.html">
<link href="../../bower_components/prism/themes/prism.css" rel="stylesheet" />
<link href="../../bower_components/prism-js/assets/line-numbers.css" rel="stylesheet" />
<link href="../../bower_components/prism-js/assets/line-highlight.css" rel="stylesheet" />
<link href="../../bower_components/prism-js/assets/line-highlight-fix.css" rel="stylesheet" />

<link rel="import" href="../sort-canvas/sort-canvas.html">
<link rel="import" href="../sort-canvas/sort-locus-canvas.html">

<dom-module id="sort-app">
  <template>
    <style>
      :host {
        display: block;
      }
      .result {
        position: relative;

        width: 100%;
        /*height: 100vh;*/
        overflow-x: scroll;
      }
      .list {
        /*width: 600px;*/
        /*height: 100vh;*/
        /*overflow: scroll;*/
        white-space: nowrap;

        position: absolute;
        top: 0;
        left: 0;
        /* remove unnecessary space */
        font-size: 0
      }
      sort-locus-canvas {
        /*position: absolute;*/
        position: relative;;
        top: 0;
        left: 0;
        font-size: 0;
      }
      sort-row {
        margin-right: 4px;
      }
      app-toolbar {
        background-color: #4285f4;
        color: #fff;
      }
      paper-spinner {
        float: left;
      }
      paper-slider {
        --paper-slider-pin-start-color: var(--google-blue-700);
      }
    </style>
    <app-drawer-layout id="drawerLayout">
      <app-drawer>
        <paper-listbox style="height: 100%; overflow: auto;" selected="0">
          <template is="dom-repeat" items="[[sortMethod]]">
           <paper-item on-tap="_handleSortMethodChanged">
             [[item.name]]
           </paper-item>
           <!-- <paper-item on-tap="_handlePatternListTap" style="justify-content: space-between;">
             {{item.name}}

             <life-icon-toggle pressed="{{item.starred}}"></life-icon-toggle>
           </paper-item> -->
          </template>
          <!-- <div class="">
            hogehogehoge
          </div> -->
          <paper-button on-tap="_openNewSortMethodDialog" style="text-transform: none;">
              <iron-icon icon="add" item-icon></iron-icon>
              ソートアルゴリズムを追加
          </paper-button>
          <paper-button on-tap="_openSettingsDialog" style="text-transform: none;">
              <iron-icon icon="settings" item-icon></iron-icon>
              設定
          </paper-button>
        </paper-listbox>
      </app-drawer>

      <app-header-layout>
        <app-header fixed condenses>
          <app-toolbar>
            <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
            <div main-title>Sort Visualizer</div>
          </app-toolbar>
        </app-header>

        <h2>[[_selectedSortMethod.name]]</h2>
        <sort-canvas id="canvas" array="[[array]]" cell-size="[[cellSize]]"></sort-canvas>
        <div class="result">
          <sort-locus-canvas array="[[array]]"></sort-locus-canvas>
          <div class="list">
            <template is="dom-repeat" items="[[array]]">
              <!-- <sort-row row="[[item]]" on-tap="_handleTap"></sort-row> -->
              <!-- <sort-row row="[[item]]" on-mouseenter="_handleTap"></sort-row> -->
              <sort-row row="[[item]]"></sort-row>
            </template>
          </div>
        </div>

        <prism-js language="javascript" linenumbers="true" input-value="[[_selectedSortMethod.code]]">
        </prism-js>
      </app-header-layout>

      <div>
        <paper-dialog id="sortStatusDialog">
          <paper-spinner active></paper-spinner><p>ソートしています...</p>
        </paper-dialog>

        <paper-dialog id="newSortDialog">
          <h2>Register new Sort Algorithm</h2>
          <paper-dialog-scrollable>
            <paper-input label="Identifier" auto-validate pattern="[a-zA-Z]*" error-message="Invalid character!!" value="{{_newSortMethod.identifier}}" placeholder="quickSort"></paper-input>
            <paper-input label="Name" value="{{_newSortMethod.name}}" placeholder="クイックソート"></paper-input>
            <paper-textarea label="Code" value="{{_newSortMethod.codeString}}" placeholder="function(array){ .... }"></paper-textarea>
          </paper-dialog-scrollable>
          <div class="buttons">
            <paper-button dialog-confirm autofocus on-tap="_registerNewSortMethod">OK</paper-button>
          </div>
        </paper-dialog>

        <paper-dialog id="settingsDialog">
          <paper-dropdown-menu label="エントリ数">
            <paper-listbox class="dropdown-content" selected="{{settings.arrayLength}}">
              <paper-item>16</paper-item>
              <paper-item>32</paper-item>
              <paper-item>64</paper-item>
              <paper-item>128</paper-item>
              <paper-item>256</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>


          <paper-dropdown-menu label="初期値の設定方法">
            <paper-listbox class="dropdown-content" selected="{{settings.initialization}}">
              <paper-item>昇順</paper-item>
              <paper-item>降順</paper-item>
              <paper-item>ランダム</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>


          <paper-dropdown-menu label="キャンバスの大きさ">
            <paper-listbox class="dropdown-content" selected="{{settings.cellSize}}">
              <paper-item>1</paper-item>
              <paper-item>2</paper-item>
              <paper-item>3</paper-item>
              <paper-item>4</paper-item>
              <paper-item>5</paper-item>
              <paper-item>6</paper-item>
              <paper-item>7</paper-item>
              <paper-item>8</paper-item>
              <paper-item>9</paper-item>
              <paper-item>10</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>

          <paper-slider label="色相" value="{{bgRed}}" max="360" pin></paper-slider>

          <div class="buttons">
            <paper-button dialog-confirm autofocus on-tap="">OK</paper-button>
          </div>
        </paper-dialog>
      </div>
    </app-drawer-layout>
  </template>

  <script>
    if (!Array.prototype.shuffle) {
      Array.prototype.shuffle = function() {
        // shallow copy
        var array = [].concat(Object(this));
        var n = array.length, t, i;

        while (n) {
          i = Math.floor(Math.random() * n--);
          t = array[n];
          array[n] = array[i];
          array[i] = t;
        }
        return array;
      }
    }
    Polymer({

      is: 'sort-app',

      properties: {
        array: {
          type: Object,
          value: [],
          notify: true
        },
        arrayLength: {
          type: Number,
          // value: 100,
          computed: '_computeArrayLength(settings.arrayLength)',
        },
        cellSize: {
          type: Number,
          computed: '_computeCellSize(settings.cellSize)'
        },
        initialValue: {
          type: Object,
          computed: '_computeInitialValue(settings.initialization, settings.arrayLength)'
        },
        sortMethod: {
          type: Object,
          value: []
        },
        settings: {
          type: Object,
          value: {}
        },
        _selectedSortMethod: {
          type: Object,
        },
        _newSortMethod: {
          type: Object,
          value: {}
        }
      },

      ready: function(){
        // let seed = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19];
        // let seed = Array.from(Array(this.arrayLength).keys());
        // let a = [];

        // for(let i = 0; i < 600 - 1; i++){
        //   a.push(seed.shuffle());
        //   // this.push('array', seed.shuffle());
        // }
        // for(let i = 0; i < 1; i++){
        //   a.push(this.quicksort(seed.shuffle()));
        // }

        // a = this.insertionSort(seed.shuffle());
        // a = this.bubbleSort(seed.shuffle());
        //
        // this.set('array', a);

        // console.log(this.array);


        // this.push('sortMethod', ["クイックソート", this.quicksort]);
        // this.push('sortMethod', ["挿入ソート", this.insertionSort]);
        // this.push('sortMethod', ["バブルソート", this.bubbleSort]);

        this.sortMethod = [{
          identifier: 'insertionSort',
          name: "挿入ソート",
          valid: true, // コードが valid かどうか
          code:
function(_array){
  let array = [].concat(_array);
  let result = [];
  result.push([].concat(array));

  for(let i = 1; i < array.length; i++){
    let t = array[i];
    if(array[i - 1] > t){
      let j;
      for(j = i; j > 0 && array[j - 1] > t; j--){
        array[j] = array[j - 1];
        // result.push([].concat(array));
      }
      array[j] = t;
    }
    result.push([].concat(array));
  }

  return result;
},
        },
        {
          identifier: 'bubbleSort',
          name: "バブルソート",
          valid: true,
          code:
function(_array){
  let array = [].concat(_array);
  let result = [];

  result.push([].concat(array));
  for(let i = 0; i < array.length; i++){
    for(let j = 0; j < array.length - 1; j++){
      if(array[j + 1] < array[j]){
        [array[j + 1], array[j]] = [array[j], array[j + 1]];
      }
    }
    result.push([].concat(array));
  }

  return result;
},
        }];
        this.notifyPath('sortMethod');


        this.settings.arrayLength = 3;
        this.settings.cellSize = 2;
        this.settings.initialization = 2;


        this.set('_selectedSortMethod', this.sortMethod[0]);
        this._executeSort();
      },

      _computeArrayLength: function(arrayLength){
        if(!arrayLength) arrayLength = 3;
        return Math.pow(2, 4 + arrayLength);
      },

      _computeCellSize: function(cellSize){
        if(!cellSize) cellSize = 2;
        return cellSize + 1;
      },
      _computeInitialValue: function(initialization, arrayLength){
        if(!initialization) initialization = 2;
        if(initialization === 0){
          return Array.from(Array(this.arrayLength).keys());
        }
        else if(initialization === 1){
          return Array.from(Array(this.arrayLength).keys()).reverse();
        }
        else if(initialization === 2){
          return Array.from(Array(this.arrayLength).keys()).shuffle();
        }
        else{
          return [];
        }
      },
      quicksort: function(array){
        let result = [];

        let qsort = function(a){
          if(a.length === 0){
            return [];
          }
          else if(a.length === 1){
            return a;
          }
          else if(a.length === 2){
            if(a[0] < a[1]){
              return a;
            } else {
              return a.reverse();
            }
          }
          else{
            let pivot = a[0];
            let rest = a.slice(1);
            let smaller = rest.filter((t) => t <= pivot);
            let larger = rest.filter((t) => t > pivot);

            return qsort(smaller).concat(pivot).concat(qsort(larger));
          }
        }

        return qsort(array);
      },


      _executeSort: function(){
        // let seed = Array.from(Array(this.arrayLength).keys()).shuffle();
        let seed = this.initialValue;
        let sortFunc = this._selectedSortMethod.code;

        let waitPromise = new Promise((resolve, reject) => {
          setTimeout(resolve, 100);
        });
        let sortPromise = new Promise((resolve, reject) => {
          resolve(sortFunc(seed));
        });

        this.$.sortStatusDialog.open();

        Promise.all([sortPromise, waitPromise]).then((values) => {
          this.set('array', values[0]);
          this.$.sortStatusDialog.close();
        });

      },


      // event listeners
      _handleTap: function(e){
        console.log(e);
        this.$.canvas.reDrawAt(e.model.index);
      },
      _handleSortMethodChanged: function(e){
        this.set('_selectedSortMethod', e.model.get('item'));
        this._executeSort();
      },

      _notifyResize: function(){
        this.$.newSortDialog.notifyResize();
      },

      _openNewSortMethodDialog: function(e){
        if(this.$.drawerLayout.narrow) this.$.drawerLayout.drawer.close();
        this.$.newSortDialog.open();
      },
      _openSettingsDialog: function(e){
        if(this.$.drawerLayout.narrow) this.$.drawerLayout.drawer.close();
        this.$.settingsDialog.open();
      },

      _registerNewSortMethod: function(e){
        // validate
        // test sort code
        let temp = {};
        temp.identifier = this._newSortMethod.identifier;
        temp.name = this._newSortMethod.name;
        temp.code = eval(`(${this._newSortMethod.codeString})`);
        temp.valid = true;

        // register
        this.push('sortMethod', temp);
        this._newSortMethod = {};
      }
    });
  </script>
</dom-module>
