<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">

<dom-module id="sort-new-method-dialog">
  <template>
    <paper-dialog id="dialog">
      <paper-dialog-scrollable>
        <paper-input id="identifier" label="Identifier" auto-validate pattern="[a-zA-Z]*" error-message="Invalid character!!" value="{{_newSortMethod.identifier}}" placeholder="quickSort" required></paper-input>
        <paper-input label="Name" value="{{_newSortMethod.name}}" placeholder="クイックソート" required></paper-input>
        <paper-textarea id="textarea" label="Code" value="{{_newSortMethod.codeString}}" placeholder="function(array){ .... }" on-value-changed="_notifyResize" error-message="不正な JavaScript コードです" required></paper-textarea>

      <div class="testcases">
        <h2>テスト結果</h2>
        <div class="case1">
          <h3>テストケース 1</h3>
          <iron-icon icon="check-circle"></iron-icon>
          OK
        </div>
        <div class="case2">
          <h3>テストケース 2</h3>
          <iron-icon icon="check-circle"></iron-icon>
          OK
        </div>
        <div class="case3">
          <h3>テストケース 3</h3>
          <iron-icon icon="check-circle"></iron-icon>
          OK
        </div>
      </div>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button autofocus on-tap="_handleTap">OK</paper-button>
      </div>
    </paper-dialog>
  </template>

  <style>
  </style>

  <script>
    Polymer({
      is: 'sort-new-method-dialog',
      properties: {
        _newSortMethod: {
          type: Object,
          value: {}
        },
      },
      _notifyResize: function(){
        this.$.dialog.notifyResize();
      },
      _handleTap: function(){
        // validate
        if(this._validateCode() && !this.$.identifier.invalid && this._runTest()){
          this.$.dialog.close();
          this.fire('sort-method-register', {detail: this._newSortMethod});
        }
        else{

        }

      },
      _validateCode: function(){
        let codeFunc;
        try {
           codeFunc = eval(`(${this._newSortMethod.codeString})`);
        } catch(e) {
           console.error(e);
           this.$.textarea.invalid = true;
           return false;
        }
        this.$.textarea.invalid = false;
        this._newSortMethod.code = codeFunc;

        return true;
      },
      _assertValid: function(expected, actual){
        if (expected === actual) return true;
        if (expected == null || actual == null) return false;

        for (let i = 0; i < actual.length; i++) {
          if (actual[i].length != expected.length) return false;
        }

        let act = actual.slice(-1)[0];
        for (let i = 0; i < expected.length; i++){
          if (expected[i] !== act[i]) return false;
        }
        return true;
      },
      _runTest: function(){
        let testcase = [
          {
            input: [ 5, 12, 8, 9, 0, 7, 4, 2, 3, 14, 6, 1, 11, 15, 10, 13 ],
            expect: [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15 ]
          },
          {
            input: [13, 29, 27, 18, 7, 24, 25, 20, 11, 22, 17, 23, 3, 1, 28, 8, 14, 21, 10, 4, 6, 5, 30, 12, 15, 19, 26, 16, 9, 2],
            expect: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30]
          },
          {
            input: [59, 37, 49, 55, 9, 47, 11, 57, 53, 32, 40, 38, 58, 54, 61, 20, 25, 29, 22, 27, 30, 5, 8, 26, 45, 21, 35, 19, 31, 39, 2, 16, 28, 43, 33, 12, 46, 6, 3, 63, 34, 24, 23, 10, 50, 62, 18, 42, 44, 15, 36, 13, 1, 17, 48, 64, 4, 60, 56, 41, 14, 51, 7, 52],
            expect: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64]
          },
        ];


        let testResult;
        try {
          let f = this._newSortMethod.code;
          testResult = testcase.map((test) => {
            return this._assertValid(test.expect, f(test.input));
          });
        } catch(e) {
          console.error(e);
          return false;
        }

        return testResult.every((e) => e);
      },

      open: function(){
        this.$.dialog.open();
      },

    });
  </script>
</dom-module>
